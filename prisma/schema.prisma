generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  VOLUNTEER
  MANAGER
  ADMIN
}

enum EventStatus {
  DRAFT
  PENDING
  APPROVED
  CANCELLED
  COMPLETED
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  WAITLIST
}

enum NotificationTargetType {
  EVENT
  POST
  REGISTRATION
  USER
  OTHER
}

enum PostStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PostVisibility {
  PUBLIC
  PRIVATE
}

model User {
  id              String   @id @default(uuid()) @db.Uuid
  fullName        String
  avatarUrl       String?
  bio             String?
  phoneNumber     String
  location        String
  dob             DateTime @db.Date
  email           String   @unique
  passwordHash    String?
  googleId        String?  @unique
  avatarUrls      String?
  role            UserRole @default(VOLUNTEER)
  isActive        Boolean  @default(true)
  isEmailVerified Boolean  @default(false)
  createdAt       DateTime @default(now()) @db.Timestamptz
  updatedAt       DateTime @updatedAt @db.Timestamptz

  // relations
  managedEvents       Event[]              @relation("ManagerEvents")
  posts               Post[]
  comments            Comment[]
  eventRegs           EventRegistration[]
  notifications       Notification[]
  postLikes           PostLike[]
  commentLikes        CommentLike[]
  refreshTokens       RefreshToken[]
  verificationTokens  VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  pushSubscriptions   PushSubscription[]
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  events Event[]
}

model Event {
  id          String      @id @default(uuid()) @db.Uuid
  name        String
  description String?
  location    String?
  startTime   DateTime?   @db.Timestamptz
  endTime     DateTime?   @db.Timestamptz
  status      EventStatus @default(DRAFT)
  categoryId  Int?
  capacity    Int?
  coverUrl    String?
  createdAt   DateTime    @default(now()) @db.Timestamptz
  updatedAt   DateTime    @updatedAt @db.Timestamptz

  managerId String @db.Uuid
  manager   User   @relation("ManagerEvents", fields: [managerId], references: [id], onDelete: Restrict)

  category      Category?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  posts         Post[]
  registrations EventRegistration[]

  @@index([startTime])
  @@index([categoryId])
}

model EventRegistration {
  id           String             @id @default(uuid()) @db.Uuid
  eventId      String             @db.Uuid
  userId       String             @db.Uuid
  status       RegistrationStatus @default(PENDING)
  registeredAt DateTime           @default(now()) @db.Timestamptz

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

model Post {
  id         String         @id @default(uuid()) @db.Uuid
  eventId    String         @db.Uuid
  userId     String?        @db.Uuid
  content    String
  medias     PostMedia[]
  status     PostStatus     @default(PENDING)
  visibility PostVisibility @default(PUBLIC)
  createdAt  DateTime       @default(now()) @db.Timestamptz
  updatedAt  DateTime       @updatedAt @db.Timestamptz

  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author    User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  comments  Comment[]
  postLikes PostLike[]

  @@index([eventId])
}

model PostMedia {
  id        String   @id @default(uuid()) @db.Uuid
  url       String
  type      String
  
  postId    String   @db.Uuid
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @db.Uuid
  userId    String?  @db.Uuid
  content   String
  parentId  String?
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  post         Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  author       User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  commentLikes CommentLike[]

  @@index([postId])
}

model PostLike {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  postId    String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

model CommentLike {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  commentId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Notification {
  id         String                  @id @default(uuid()) @db.Uuid
  userId     String                  @db.Uuid
  content    String
  isRead     Boolean                 @default(false)
  targetType NotificationTargetType?
  targetId   String?
  createdAt  DateTime                @default(now()) @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  device    String? // "Chrome on Windows", "iPhone 14", ...
  ipAddress String? // địa chỉ IP khi đăng nhập
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz
  expiresAt DateTime @db.Timestamptz
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  userId    String   @db.Uuid
  expiresAt DateTime @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  userId    String   @db.Uuid
  expiresAt DateTime @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  endpoint  String   @unique
  p256dh    String   // Public key
  auth      String   // Auth secret
  userAgent String?  // Browser/device info
  createdAt DateTime @default(now()) @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
